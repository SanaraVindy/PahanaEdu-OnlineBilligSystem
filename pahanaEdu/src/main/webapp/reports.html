<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PahanaEdu - Reports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0;
        }

        .container-box {
            max-width: 1100px;
            margin: 40px auto;
            background: rgba(255, 255, 255, 0.94);
            padding: 40px 30px;
            border-radius: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }

        .title-header {
            background: linear-gradient(to right, #6a1b9a, #ab47bc);
            color: white;
            padding: 18px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .form-control, .form-select {
            border-radius: 12px;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 5px rgba(106, 27, 154, 0.5);
            border-color: #6a1b9a;
        }

        .btn-purple {
            background-color: #6a1b9a;
            border: none;
            color: white;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-purple:hover {
            background-color: #4a148c;
        }

        .table thead {
            background-color: #ab47bc;
            color: white;
        }

        .table tbody tr:hover {
            background-color: #f3e5f5;
        }

        .export-btns .btn {
            margin-right: 10px;
        }

        .report-label {
            font-weight: 600;
            color: #6a1b9a;
        }

        /* KPI Cards Styling */
        .kpi-card {
            background: #e1bee7;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .kpi-card h5 {
            color: #4a148c;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .kpi-card h2 {
            color: #6a1b9a;
            font-weight: 700;
        }

        /* Chart containers */
        #chartsRow {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: linear-gradient(to right, #ce93d8, #e1bee7);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.2);
        }

        .chart-title {
            color: #4a148c;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
        }

        /* Live filter input styling */
        #liveFilterInput {
            max-width: 300px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1.5px solid #6a1b9a;
            padding: 8px 12px;
            font-size: 1rem;
            outline: none;
            transition: box-shadow 0.3s ease;
        }

        #liveFilterInput:focus {
            box-shadow: 0 0 8px rgba(106, 27, 154, 0.7);
            border-color: #4a148c;
        }
        
        /* Loading spinner */
        .spinner-container {
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(to right, #6a1b9a, #8e24aa); padding: 10px 30px;">
    <div class="container-fluid">
        <!-- Brand / Logo -->
        <a class="navbar-brand fw-bold" href="#">
            <i class="bi bi-house-door-fill"></i> PahanaEdu
        </a>

        <!-- Toggle for mobile view -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navigation Links -->
        <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <!-- Home tab -->
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">
                        <i class="bi bi-house-fill"></i> Home
                    </a>
                </li>
            </ul>

            <!-- Logout button -->
            <div class="d-flex">
                <a href="#" class="btn btn-light text-dark fw-semibold rounded-pill">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="container-box">
    <div class="title-header">
        ðŸ“Š Reports Dashboard - PahanaEdu
    </div>

    <!-- Advanced Filter Form -->
    <div class="row g-3 mb-3 align-items-end">
        <div class="col-md-3">
            <label class="report-label" for="fromDate">From Date</label>
            <input type="date" id="fromDate" name="fromDate" class="form-control" value="2024-01-01" />
        </div>
        <div class="col-md-3">
            <label class="report-label" for="toDate">To Date</label>
            <input type="date" id="toDate" name="toDate" class="form-control" value="2024-12-31" />
        </div>
        <div class="col-md-3">
            <label class="report-label" for="customerLimit">Top Customers (Limit)</label>
            <input type="number" id="customerLimit" name="customerLimit" class="form-control" value="10" min="1" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button id="generateReportBtn" type="button" class="btn btn-purple w-100">
                <i class="bi bi-bar-chart-fill"></i> Generate Report
            </button>
        </div>
    </div>

    <!-- KPI Cards Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="kpi-card">
                <h5>Total Sales</h5>
                <h2 id="totalSalesKPI">LKR 0.00</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card">
                <h5>Total Orders</h5>
                <h2 id="totalOrdersKPI">0</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card">
                <h5>Avg. Order Value</h5>
                <h2 id="avgOrderValueKPI">LKR 0.00</h2>
            </div>
        </div>
    </div>

    <!-- Live text filter -->
    <input
        type="text"
        id="liveFilterInput"
        placeholder="Live Filter: Search in reports..."
        title="Type to filter the reports table"
    />

    <!-- Export Buttons -->
    <div class="export-btns text-end mb-3">
        <button type="button" class="btn btn-outline-success">
            <i class="bi bi-file-earmark-excel-fill"></i> Export Excel
        </button>
        <button type="button" class="btn btn-outline-danger">
            <i class="bi bi-file-pdf-fill"></i> Export PDF
        </button>
    </div>
    
    <!-- Loading spinner -->
    <div id="loadingSpinner" class="text-center spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-2">Generating your report...</span>
    </div>

    <!-- Charts Row -->
    <div id="chartsRow" class="row g-4">
        <!-- Existing Bar Chart for Total Spending -->
        <div class="col-md-4 chart-container">
            <div class="chart-title">Top Customers by Total Spending</div>
            <canvas id="totalSpentChart"></canvas>
        </div>
        
        <!-- Pie Chart for Top Categories -->
        <div class="col-md-4 chart-container">
            <div class="chart-title">Distribution of Top Categories</div>
            <canvas id="topCategoriesChart"></canvas>
        </div>

        <!-- New Bar Chart for Loyalty Points -->
        <div class="col-md-4 chart-container">
            <div class="chart-title">Top Customers by Loyalty Points</div>
            <canvas id="loyaltyPointsChart"></canvas>
        </div>
    </div>

    <!-- Reports Table -->
    <div class="table-responsive">
        <table id="reportsTable" class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Customer Name</th>
                    <th>Email</th>
                    <th>Total Orders</th>
                    <th>Total Spent (LKR)</th>
                    <th>Loyalty Points</th>
                    <th>Top Category</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // Initializing Chart.js instances as global variables
    let totalSpentChartInstance;
    let topCategoriesChartInstance;
    let loyaltyPointsChartInstance;

    /**
     * Fetches report data from the Java backend.
     * @param {string} fromDate The start date for the report.
     * @param {string} toDate The end date for the report.
     * @param {number} customerLimit The number of top customers to return.
     * @returns {Promise<Array<Object>>} A promise that resolves with the report data.
     */
    async function fetchReportData(fromDate, toDate, customerLimit) {
        // The URL needs to point to your Java servlet.
        // It's crucial that this URL is reachable and the server is running.
        // The "Failed to fetch" error is often a network or CORS issue, as a browser
        // cannot connect to a localhost server from this hosted environment without
        // specific server-side configurations.
        const url = new URL('http://localhost:8080/mavenproject2/api/top-customers'); 
        url.searchParams.append('startDate', fromDate);
        url.searchParams.append('endDate', toDate);
        url.searchParams.append('limit', customerLimit);

        const response = await fetch(url);
        
        // Handle HTTP errors
        if (!response.ok) {
            // Check for JSON response. If not, this means a network error or the server sent HTML.
            try {
                const error = await response.json();
                throw new Error(error.error || `HTTP Error: ${response.status} - ${response.statusText}`);
            } catch (jsonError) {
                // If the response is not valid JSON, it's likely a server-side error page (like a 404 HTML page)
                throw new Error(`Server returned an invalid response (status: ${response.status})`);
            }
        }

        return await response.json();
    }

    // Function to populate the reports table with data
    function populateReportsTable(data) {
        const tableBody = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = ''; // Clear existing data

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data found for the selected period.</td></tr>';
            return;
        }

        data.forEach(customer => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${customer.rank}</td>
                <td>${customer.firstName} ${customer.lastName}</td>
                <td>${customer.email}</td>
                <td>${customer.totalOrders}</td>
                <td>LKR ${customer.totalSpent.toFixed(2)}</td>
                <td>${customer.loyaltyPoints}</td>
                <td>${customer.topCategory}</td>
            `;
        });
    }

    // Function to update the charts with new data
    function updateCharts(data) {
        const customerNames = data.map(c => `${c.firstName} ${c.lastName}`);
        const totalSpent = data.map(c => c.totalSpent);
        const loyaltyPoints = data.map(c => c.loyaltyPoints);

        // Calculate category distribution for the pie chart
        const categoryCounts = data.reduce((acc, customer) => {
            acc[customer.topCategory] = (acc[customer.topCategory] || 0) + 1;
            return acc;
        }, {});
        
        const categoryLabels = Object.keys(categoryCounts);
        const categoryData = Object.values(categoryCounts);
        const categoryColors = ['#6a1b9a', '#ab47bc', '#ce93d8', '#e1bee7', '#9c27b0', '#ba68c8'];

        // Bar Chart for Total Spending
        if (totalSpentChartInstance) {
            totalSpentChartInstance.destroy(); // Destroy previous instance
        }
        const totalSpentCtx = document.getElementById('totalSpentChart').getContext('2d');
        totalSpentChartInstance = new Chart(totalSpentCtx, {
            type: 'bar',
            data: {
                labels: customerNames,
                datasets: [{
                    label: 'Total Spent (LKR)',
                    data: totalSpent,
                    backgroundColor: '#6a1b9a',
                    borderRadius: 5,
                    barPercentage: 0.6,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: val => `LKR ${val}` }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });

        // Pie Chart for Top Categories
        if (topCategoriesChartInstance) {
            topCategoriesChartInstance.destroy(); // Destroy previous instance
        }
        const topCategoriesCtx = document.getElementById('topCategoriesChart').getContext('2d');
        topCategoriesChartInstance = new Chart(topCategoriesCtx, {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: categoryColors.slice(0, categoryLabels.length),
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // New Bar Chart for Loyalty Points
        if (loyaltyPointsChartInstance) {
            loyaltyPointsChartInstance.destroy();
        }
        const loyaltyPointsCtx = document.getElementById('loyaltyPointsChart').getContext('2d');
        loyaltyPointsChartInstance = new Chart(loyaltyPointsCtx, {
            type: 'bar',
            data: {
                labels: customerNames,
                datasets: [{
                    label: 'Loyalty Points',
                    data: loyaltyPoints,
                    backgroundColor: '#ab47bc',
                    borderRadius: 5,
                    barPercentage: 0.6,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    // Function to update the KPI cards
    function updateKPIs(data) {
        const totalSales = data.reduce((sum, customer) => sum + customer.totalSpent, 0);
        const totalOrders = data.reduce((sum, customer) => sum + customer.totalOrders, 0);
        const avgOrderValue = totalSales / (totalOrders > 0 ? totalOrders : 1);

        document.getElementById('totalSalesKPI').innerText = `LKR ${totalSales.toFixed(2)}`;
        document.getElementById('totalOrdersKPI').innerText = totalOrders.toString();
        document.getElementById('avgOrderValueKPI').innerText = `LKR ${avgOrderValue.toFixed(2)}`;
    }


    // Function to handle the generation of the report
    async function generateReport() {
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'flex';
        // Clear previous error messages
        document.getElementById('reportsTable').getElementsByTagName('tbody')[0].innerHTML = '';

        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        const customerLimit = parseInt(document.getElementById('customerLimit').value, 10);
        
        // Basic validation
        if (!fromDate || !toDate || isNaN(customerLimit) || customerLimit < 1) {
            const tableBody = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Please enter valid dates and a number for the customer limit.</td></tr>';
            document.getElementById('loadingSpinner').style.display = 'none';
            return;
        }

        try {
            const reportData = await fetchReportData(fromDate, toDate, customerLimit);
            populateReportsTable(reportData);
            updateKPIs(reportData);
            updateCharts(reportData);
        } catch (error) {
            console.error('Failed to generate report:', error);
            const tableBody = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
            let errorMessage = '';

            // Check for a network-specific error
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
                errorMessage = 'Failed to connect to the backend server. This is most likely a network or Cross-Origin Resource Sharing (CORS) issue, as the browser cannot connect to your local "localhost" server from this hosted environment. Please ensure your Java servlet is running and configured correctly.';
            } else {
                errorMessage = `An error occurred while generating the report. Error: ${error.message}`;
            }

            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${errorMessage}</td></tr>`;
        } finally {
            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    }

    // Live Filter Functionality (remains the same)
    const liveFilterInput = document.getElementById('liveFilterInput');
    liveFilterInput.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        const reportsTable = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
        const rows = reportsTable.getElementsByTagName('tr');

        Array.from(rows).forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });

    // Attach event listener to the "Generate Report" button
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);

    // Initial report generation on page load
    window.onload = function() {
        generateReport();
    };

</script>

</body>
</html>
