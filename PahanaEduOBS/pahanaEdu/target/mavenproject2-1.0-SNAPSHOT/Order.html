<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Billing - PahanaEdu</title>
    <!-- Use Inter font for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS for utility classes and Bootstrap for components -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body {
            /* Fallback font for safety */
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f') no-repeat center center fixed;
            background-size: cover;
        }
        .container-box {
            max-width: 1300px;
            margin: 40px auto;
            background: rgba(255, 255, 255, 0.94);
            padding: 40px 30px;
            border-radius: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }
        .title-header {
            background: linear-gradient(to right, #6a1b9a, #ab47bc);
            color: white;
            padding: 18px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
        }
        .btn-purple {
            background-color: #6a1b9a;
            border: none;
            color: white;
            border-radius: 10px;
            font-weight: 600;
        }
        .btn-purple:hover {
            background-color: #4a148c;
        }
        .card-header-purple {
            background-color: #ab47bc;
            color: white;
        }
        .text-purple {
            color: #6a1b9a;
        }
        .alert-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(to right, #6a1b9a, #8e24aa); padding: 10px 30px;">
    <div class="container-fluid">
        <a class="navbar-brand me-3" href="#" onclick="history.back()">
            <i class="bi bi-arrow-left-circle-fill"></i>
        </a>

        <a class="navbar-brand fw-bold" href="#">
            <i class="bi bi-house-door-fill"></i> PahanaEdu
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <!-- This link's functionality is handled by the script below -->
                    <a id="dashboard-link" class="nav-link" href="#">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
            </ul>

            <div class="d-flex">
                <a href="logout.html" class="btn btn-light text-dark fw-semibold rounded-pill">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- This script is for handling the dashboard link based on a hardcoded user role for demonstration -->
<script>
    // In a real application, you would get the user's role from a session or API call.
    // For this example, let's pretend we have a variable `userRole`.
    // Change this to 2 to test the other case.
    const userRole = 1;

    const dashboardLink = document.getElementById('dashboard-link');

    if (dashboardLink) {
        if (userRole === 1) {
            dashboardLink.href = 'admin-dashboard.html';
            dashboardLink.innerHTML = '<i class="bi bi-speedometer2"></i> Admin Dashboard';
        } else if (userRole === 2) {
            dashboardLink.href = 'dashboard.html';
            dashboardLink.innerHTML = '<i class="bi bi-speedometer2"></i> Dashboard';
        }
    }
</script>

<div class="container-box">
    <div class="title-header">
        ðŸ’° Order & Billing - PahanaEdu
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card shadow-sm h-100">
                <div class="card-header card-header-purple fw-bold">
                    <i class="bi bi-person-fill"></i> Customer & Item Details
                </div>
                <div class="card-body">
                    <form id="billingForm">
                        <div class="mb-3">
                            <label for="customerSelect" class="form-label">Customer</label>
                            <select class="form-select" id="customerSelect" required>
                                <option value="">Select a customer...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="itemSelect" class="form-label">Add Item to Cart</label>
                            <div class="input-group">
                                <select class="form-select" id="itemSelect" required>
                                    <option value="">Select an item...</option>
                                </select>
                                <input type="number" class="form-control" id="itemQuantity" placeholder="Qty" min="1" value="1" style="max-width: 100px;" required>
                                <button type="button" class="btn btn-purple" id="addItemBtn">
                                    <i class="bi bi-plus-circle-fill"></i> Add
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="Online">Online</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm h-100">
                <div class="card-header card-header-purple fw-bold">
                    <i class="bi bi-cart-fill"></i> Cart Summary
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="table-responsive flex-grow-1">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Qty</th>
                                    <th>Price</th>
                                    <th>Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cartTableBody">
                                <tr><td colspan="5" class="text-center text-muted">Cart is empty</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <div class="d-flex justify-content-between fw-bold mb-1">
                            <span>Subtotal:</span>
                            <span>Rs.<span id="subTotal">0.00</span></span>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="text-success">Discount:</span>
                            <span class="text-success">-Rs.<span id="discountAmount">0.00</span></span>
                        </div>
                        <div id="discountMessages" class="text-sm text-purple font-medium mb-2"></div>
                        <div class="d-flex justify-content-between fw-bold fs-5 text-purple">
                            <span>Grand Total:</span>
                            <span>Rs.<span id="grandTotal">0.00</span></span>
                        </div>
                        <button class="btn btn-purple btn-lg w-100 mt-3" id="payNowBtn" disabled>
                            <span id="payNowBtnText"><i class="bi bi-currency-dollar"></i> Pay Now</span>
                            <span id="payNowBtnLoading" class="hidden">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Processing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer" class="alert-box"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Define API endpoints. Note: 'localhost' will not work in the Canvas environment.
    // Replace these with your actual deployed API URLs.
    const ITEMS_API_URL = "http://localhost:8080/OBS_PahanaEdu_BE/api/items";
    const CUSTOMERS_API_URL = "http://localhost:8080/OBS_PahanaEdu_BE/api/customers";
    const BILLING_API_URL = "http://localhost:8080/OBS_PahanaEdu_BE/api/billing";

    // Get all the DOM elements we'll be interacting with
    const itemSelect = document.getElementById('itemSelect');
    const customerSelect = document.getElementById('customerSelect');
    const itemQuantityInput = document.getElementById('itemQuantity');
    const addItemBtn = document.getElementById('addItemBtn');
    const cartTableBody = document.getElementById('cartTableBody');
    const subTotalSpan = document.getElementById('subTotal');
    const discountAmountSpan = document.getElementById('discountAmount');
    const grandTotalSpan = document.getElementById('grandTotal');
    const payNowBtn = document.getElementById('payNowBtn');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const alertContainer = document.getElementById('alertContainer');
    const discountMessagesDiv = document.getElementById('discountMessages');
    const payNowBtnText = document.getElementById('payNowBtnText');
    const payNowBtnLoading = document.getElementById('payNowBtnLoading');

    // State variables for the application
    let cart = [];
    let allItems = [];
    let allCustomers = [];
    let discount = 0;

    /**
     * Shows a Bootstrap alert message in the top-right corner.
     * @param {string} message - The message to display.
     * @param {string} type - The alert type (e.g., 'success', 'danger', 'warning', 'info').
     */
    function showAlert(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            <div>${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertContainer.appendChild(alert);
        // Automatically remove the alert after 5 seconds
        setTimeout(() => alert.remove(), 5000);
    }

    // --- Data Fetching Functions ---
    /** Fetches the list of all available items from the API. */
    async function fetchItems() {
        try {
            const res = await fetch(ITEMS_API_URL);
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            allItems = await res.json();
            populateItemSelect();
        } catch (error) {
            console.error('Error fetching items:', error);
            showAlert('Failed to load items. Please check the server connection.', 'danger');
        }
    }

    /** Fetches the list of all customers from the API. */
    async function fetchCustomers() {
        try {
            const res = await fetch(CUSTOMERS_API_URL);
            if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            allCustomers = await res.json();
            populateCustomerSelect(allCustomers);
        } catch (error) {
            console.error('Error fetching customers:', error);
            showAlert('Failed to load customers. Please check the server connection.', 'danger');
        }
    }

    /** Populates the item dropdown with fetched data. */
    function populateItemSelect() {
        itemSelect.innerHTML = '<option value="">Select an item...</option>';
        allItems.forEach(item => {
            const option = document.createElement('option');
            option.value = item.itemID;
            option.textContent = `${item.description} - Rs.${item.unitPrice.toFixed(2)}`;
            // Store item details as data attributes for easy access
            option.dataset.price = item.unitPrice;
            option.dataset.quantity = item.quantity;
            option.dataset.category = item.categoryID;
            itemSelect.appendChild(option);
        });
    }

    /** Populates the customer dropdown with fetched data. */
    function populateCustomerSelect(customers) {
        customerSelect.innerHTML = '<option value="">Select a customer...</option>';
        customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.customerID;
            option.textContent = `${customer.firstName} ${customer.lastName}`;
            // Store loyalty points as a data attribute
            option.dataset.loyaltyPoints = customer.loyaltyPoints;
            option.dataset.firstName = customer.firstName;
            option.dataset.lastName = customer.lastName;
            customerSelect.appendChild(option);
        });
    }

    // --- Cart Management Functions ---
    /** Adds the selected item to the cart or updates its quantity. */
    function addItemToCart() {
        const selectedOption = itemSelect.options[itemSelect.selectedIndex];
        const selectedItemID = selectedOption.value;
        const quantity = parseInt(itemQuantityInput.value, 10);

        if (!selectedItemID || isNaN(quantity) || quantity <= 0) {
            showAlert("Please select an item and enter a valid quantity.", 'warning');
            return;
        }

        const selectedItem = allItems.find(item => item.itemID == selectedItemID);
        if (!selectedItem) {
            showAlert("Selected item not found.", 'danger');
            return;
        }

        const existingCartItem = cart.find(item => item.itemID == selectedItemID);
        const totalQuantityInCart = existingCartItem ? existingCartItem.quantity + quantity : quantity;

        if (totalQuantityInCart > selectedItem.quantity) {
            showAlert(`Insufficient stock. Only ${selectedItem.quantity} of this item are available.`, 'warning');
            return;
        }

        if (existingCartItem) {
            existingCartItem.quantity += quantity;
        } else {
            const newCartItem = {
                itemID: selectedItem.itemID,
                description: selectedItem.description,
                unitPrice: selectedItem.unitPrice,
                quantity: quantity,
                categoryID: selectedItem.categoryID
            };
            cart.push(newCartItem);
        }

        renderCart();
    }

    /** Removes an item from the cart based on its itemID. */
    function removeItemFromCart(itemID) {
        cart = cart.filter(item => item.itemID != itemID);
        renderCart();
    }

    /** Calculates and updates the subtotal, discount, and grand total. */
    function calculateTotals() {
        const subtotal = cart.reduce((total, item) => total + (item.unitPrice * item.quantity), 0);
        let totalDiscountPercentage = 0;
        let discountMessages = [];

        const selectedCustomerId = customerSelect.value;
        const selectedCustomer = allCustomers.find(cust => cust.customerID == selectedCustomerId);

        // Discount Rule 1: 10% for total >= Rs.7000
        if (subtotal >= 7000) {
            totalDiscountPercentage += 10;
            discountMessages.push('10% for large purchase (>Rs.7000)');
        }

        // Discount Rule 2: 5% for any item in Children's category (ID 7)
        const hasChildrensItem = cart.some(item => item.categoryID == 7);
        if (hasChildrensItem) {
            totalDiscountPercentage += 5;
            discountMessages.push('5% on children\'s book category');
        }

        // Discount Rule 3: 5% for customer loyalty points > 10000
        if (selectedCustomer && selectedCustomer.loyaltyPoints > 10000) {
            totalDiscountPercentage += 5;
            discountMessages.push('5% for loyalty points (>10000)');
        }

        const newDiscount = Math.round((subtotal * (totalDiscountPercentage / 100)) * 100) / 100;

        // Display a general alert only if the discount state changes
        if (newDiscount > 0 && discount === 0) {
            showAlert("Discount applied!", "info");
        } else if (newDiscount === 0 && discount > 0) {
            showAlert("Discount removed.", "info");
        }

        discount = newDiscount;
        const grandTotal = subtotal - discount;

        subTotalSpan.textContent = subtotal.toFixed(2);
        discountAmountSpan.textContent = discount.toFixed(2);
        grandTotalSpan.textContent = grandTotal.toFixed(2);
        
        // Display a list of applied discounts
        discountMessagesDiv.textContent = discountMessages.length > 0 ? `Discounts Applied: ${discountMessages.join(', ')}` : '';
        
        // Disable or enable the Pay Now button based on cart state
        payNowBtn.disabled = cart.length === 0 || !customerSelect.value;
    }

    /** Renders the cart contents and updates totals. */
    function renderCart() {
        cartTableBody.innerHTML = '';
        if (cart.length === 0) {
            cartTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Cart is empty</td></tr>`;
        } else {
            cart.forEach(item => {
                const subtotal = item.unitPrice * item.quantity;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td>${item.quantity}</td>
                    <td>Rs.${item.unitPrice.toFixed(2)}</td>
                    <td>Rs.${subtotal.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger remove-item-btn" data-item-id="${item.itemID}">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                `;
                cartTableBody.appendChild(row);
            });
        }
        calculateTotals();
    }

    /**
     * Handles the payment process by sending data to the backend and
     * generating a printable invoice.
     */
async function generateAndPrintInvoice() {
    const customerID = customerSelect.value;
    const paymentMethod = paymentMethodSelect.value;

    if (!customerID) {
        showAlert('Please select a customer.', 'warning');
        return;
    }
    if (cart.length === 0) {
        showAlert('Cannot proceed with an empty cart.', 'warning');
        return;
    }

    // Show loading state on button
    payNowBtnText.classList.add('hidden');
    payNowBtnLoading.classList.remove('hidden');
    payNowBtn.disabled = true;

    // Use a try-catch block to handle potential errors during the process.
    try {
        // Step 1: Send billing data to the backend
        const res = await fetch(BILLING_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                customerID: parseInt(customerID, 10),
                cartItems: cart.map(item => ({
                    orderID: 0,
                    itemID: item.itemID,
                    quantity: item.quantity,
                    priceAtPurchase: item.unitPrice
                })),
                paymentMethod: paymentMethod
            })
        });

        // Check if the response was successful
        if (!res.ok) {
            // Handle server errors
            const errorText = await res.text();
            throw new Error(`Server responded with status: ${res.status}, Message: ${errorText}`);
        }

        // --- All the code below will only run if the backend call is successful ---

        // Step 2: If the backend call is successful, generate and print the invoice
        const date = new Date().toLocaleDateString();
        const taxRate = 0.05; // 5% tax
        const subtotal = cart.reduce((total, item) => total + (item.unitPrice * item.quantity), 0);
        const discountAmount = calculateDiscount(subtotal);
        const grandTotal = subtotal - discountAmount;

        const subTotalValue = subtotal.toFixed(2);
        const discountAmountValue = discountAmount.toFixed(2);
        const taxAmountValue = (subtotal * taxRate).toFixed(2);
        const grandTotalValue = grandTotal.toFixed(2);

        // Find selected customer details for the invoice
        const selectedCustomer = allCustomers.find(cust => cust.customerID == customerID);
        const customerName = selectedCustomer ? `${selectedCustomer.firstName} ${selectedCustomer.lastName}` : `Customer ID ${customerID}`;

        const invoiceContent = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <title>Invoice</title>
                <style>
                    body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; }
                    .invoice-box {
                        max-width: 800px;
                        margin: 30px auto;
                        padding: 40px;
                        border: 1px solid #ddd;
                        background-color: #fff;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    .header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding-bottom: 20px;
                        border-bottom: 2px solid #6a1b9a;
                        margin-bottom: 20px;
                    }
                    .header .title {
                        font-size: 32px;
                        font-weight: 700;
                        color: #6a1b9a;
                    }
                    .header .invoice-details {
                        text-align: right;
                        font-size: 14px;
                        color: #555;
                    }
                    .address-section {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 30px;
                        line-height: 1.6;
                    }
                    .address-section .company-info, .address-section .customer-info {
                        font-size: 14px;
                        color: #666;
                    }
                    .table-container {
                        border-radius: 8px;
                        overflow: hidden;
                        border: 1px solid #e0e0e0;
                        margin-bottom: 20px;
                    }
                    .invoice-box table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 14px;
                    }
                    .invoice-box table th, .invoice-box table td {
                        padding: 12px 15px;
                        text-align: left;
                    }
                    .invoice-box table thead th {
                        background-color: #6a1b9a;
                        color: #fff;
                        font-weight: 600;
                    }
                    .invoice-box table tbody tr:nth-child(even) {
                        background-color: #f8f8f8;
                    }
                    .invoice-box table tbody tr:hover {
                        background-color: #f1f1f1;
                    }
                    .totals-section {
                        width: 100%;
                        max-width: 300px;
                        margin-left: auto;
                        font-size: 16px;
                    }
                    .totals-section .line {
                        display: flex;
                        justify-content: space-between;
                        padding: 8px 0;
                        border-bottom: 1px solid #e0e0e0;
                    }
                    .totals-section .line:last-child {
                        border-bottom: none;
                    }
                    .totals-section .grand-total {
                        font-size: 20px;
                        font-weight: 700;
                        color: #4a148c;
                    }
                    .footer {
                        text-align: center;
                        margin-top: 40px;
                        padding-top: 20px;
                        border-top: 1px solid #ddd;
                    }
                    .footer p {
                        color: #888;
                        font-size: 14px;
                    }
                    .discount-message {
                        font-size: 12px;
                        color: #6a1b9a;
                        margin-bottom: 15px;
                    }
                </style>
            </head>
            <body>
                <div class="invoice-box">
                    <div class="header">
                        <div class="title">PahanaEdu</div>
                        <div class="invoice-details">
                            Invoice #: ${Math.floor(Math.random() * 1000000)}<br>
                            Date: ${date}
                        </div>
                    </div>
                    <div class="address-section">
                        <div class="company-info">
                            <strong>PahanaEdu PLC</strong><br>
                            123 Main Street, Colombo<br>
                            Sri Lanka<br>
                            +94 11 123 4567<br>
                            contact@pahanaedu.com
                        </div>
                        <div class="customer-info">
                            <strong>Bill To:</strong><br>
                            Name: ${customerName}<br>
                            Payment Method: ${paymentMethod}
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cart.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>Rs.${item.unitPrice.toFixed(2)}</td>
                                        <td>Rs.${(item.unitPrice * item.quantity).toFixed(2)}</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="totals-section">
                        <div class="line">
                            <span>Subtotal:</span>
                            <span>Rs.${subTotalValue}</span>
                        </div>
                        <div class="line">
                            <span>Discount:</span>
                            <span style="color: #28a745;">-Rs.${discountAmountValue}</span>
                        </div>
                        <div class="line">
                            <span>Tax (5%):</span>
                            <span>Rs.${taxAmountValue}</span>
                        </div>
                        <div class="line grand-total">
                            <span>Grand Total:</span>
                            <span>Rs.${grandTotalValue}</span>
                        </div>
                    </div>
                    <div class="footer">
                        <p>Thank you for your business! We look forward to seeing you again.</p>
                    </div>
                </div>
            </body>
            </html>
        `;

        const invoiceWindow = window.open('', '_blank', 'height=600,width=800');
        if (invoiceWindow) {
            invoiceWindow.document.write(invoiceContent);
            invoiceWindow.document.close();
            invoiceWindow.focus();
            setTimeout(() => invoiceWindow.print(), 500);
        } else {
            showAlert('The pop-up window was blocked. Please disable your pop-up blocker for this site to print the invoice.', 'danger');
        }

        // Clear the cart after a successful payment
        cart = [];
        renderCart();
        showAlert('Payment successful! Your order has been processed.', 'success');

    } catch (error) {
        console.error('Billing transaction failed:', error);
        showAlert(`Billing transaction failed: ${error.message}`, 'danger');
    } finally {
        // Revert button state regardless of success or failure
        payNowBtnText.classList.remove('hidden');
        payNowBtnLoading.classList.add('hidden');
        payNowBtn.disabled = false;
    }
}

// âš ï¸ Add this helper function to handle the discount logic
function calculateDiscount(subtotal) {
    let totalDiscountPercentage = 0;
    const selectedCustomerId = customerSelect.value;
    const selectedCustomer = allCustomers.find(cust => cust.customerID == selectedCustomerId);

    // Rule 1: 10% for total >= Rs.7000
    if (subtotal >= 7000) {
        totalDiscountPercentage += 10;
    }

    // Rule 2: 5% for any item in Children's category (ID 7)
    const hasChildrensItem = cart.some(item => item.categoryID == 7);
    if (hasChildrensItem) {
        totalDiscountPercentage += 5;
    }

    // Rule 3: 5% for customer loyalty points > 10000
    if (selectedCustomer && selectedCustomer.loyaltyPoints > 10000) {
        totalDiscountPercentage += 5;
    }

    return Math.round((subtotal * (totalDiscountPercentage / 100)) * 100) / 100;
}

    // --- Event Listeners ---
    addItemBtn.addEventListener('click', addItemToCart);
    payNowBtn.addEventListener('click', generateAndPrintInvoice);
    customerSelect.addEventListener('change', calculateTotals);
    itemSelect.addEventListener('change', calculateTotals);
    // Use event delegation for dynamically created "remove" buttons
    cartTableBody.addEventListener('click', (event) => {
        const removeBtn = event.target.closest('.remove-item-btn');
        if (removeBtn) {
            const itemID = removeBtn.dataset.itemId;
            removeItemFromCart(itemID);
        }
    });

    // --- Initial setup ---
    fetchCustomers();
    fetchItems();
    renderCart();
</script>

</body>
</html>
