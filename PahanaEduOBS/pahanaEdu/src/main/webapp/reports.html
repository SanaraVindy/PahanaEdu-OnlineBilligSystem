<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PahanaEdu - Reports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0;
        }

        .container-box {
            max-width: 1100px;
            margin: 40px auto;
            background: rgba(255, 255, 255, 0.94);
            padding: 40px 30px;
            border-radius: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }

        .title-header {
            background: linear-gradient(to right, #6a1b9a, #ab47bc);
            color: white;
            padding: 18px;
            border-radius: 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .form-control, .form-select {
            border-radius: 12px;
        }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 5px rgba(106, 27, 154, 0.5);
            border-color: #6a1b9a;
        }

        .btn-purple {
            background-color: #6a1b9a;
            border: none;
            color: white;
            border-radius: 10px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-purple:hover {
            background-color: #4a148c;
        }

        .table thead {
            background-color: #ab47bc;
            color: white;
        }

        .table tbody tr:hover {
            background-color: #f3e5f5;
        }

        .export-btns .btn {
            margin-right: 10px;
        }

        .report-label {
            font-weight: 600;
            color: #6a1b9a;
        }

        /* KPI Cards Styling */
        .kpi-card {
            background: #e1bee7;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .kpi-card h5 {
            color: #4a148c;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .kpi-card h2 {
            color: #6a1b9a;
            font-weight: 700;
        }

        /* Chart containers */
        #chartsRow {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: linear-gradient(to right, #ce93d8, #e1bee7);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.2);
        }

        .chart-title {
            color: #4a148c;
            font-weight: 700;
            text-align: center;
            margin-bottom: 15px;
        }

        /* Live filter input styling */
        #liveFilterInput {
            max-width: 300px;
            margin-bottom: 15px;
            border-radius: 12px;
            border: 1.5px solid #6a1b9a;
            padding: 8px 12px;
            font-size: 1rem;
            outline: none;
            transition: box-shadow 0.3s ease;
        }

        #liveFilterInput:focus {
            box-shadow: 0 0 8px rgba(106, 27, 154, 0.7);
            border-color: #4a148c;
        }
        
        /* Loading spinner */
        .spinner-container {
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(to right, #6a1b9a, #8e24aa); padding: 10px 30px;">
    <div class="container-fluid">
        <a class="navbar-brand me-3" href="#" onclick="history.back()">
            <i class="bi bi-arrow-left-circle-fill"></i>
        </a>

        <a class="navbar-brand fw-bold" href="#">
            <i class="bi bi-house-door-fill"></i> PahanaEdu
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                            </ul>

            <div class="d-flex">
                <a href="logout.html" class="btn btn-light text-dark fw-semibold rounded-pill">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </div>
</nav>

<script>
    // Assuming the user's role is stored somewhere, e.g., in a session variable or a JavaScript variable.
    // For this example, let's pretend we have a variable `userRole`.
    // You would replace this with how you actually get the user's role.
    const userRole = 1; // Change this to 2 to test the other case.

    const dashboardLink = document.getElementById('dashboard-link');

    if (dashboardLink) {
        if (userRole === 1) {
            dashboardLink.href = 'admin-dashboard.html';
            dashboardLink.innerHTML = '<i class="bi bi-speedometer2"></i> Admin Dashboard';
        } else if (userRole === 2) {
            dashboardLink.href = 'dashboard.html';
            dashboardLink.innerHTML = '<i class="bi bi-speedometer2"></i> Dashboard';
        }
    }
</script>

<div class="container-box">
    <div class="title-header">
        ðŸ“Š Reports Dashboard - PahanaEdu
    </div>

    <!-- Advanced Filter Form -->
    <div class="row g-3 mb-3 align-items-end">
        <!-- Report Type Selector -->
        <div class="col-md-3">
            <label class="report-label" for="reportType">Report Type</label>
            <select id="reportType" name="reportType" class="form-select">
                <option value="topcustomers">Top Customers</option>
                <option value="monthly-sales-summary">Monthly Sales Summary</option>
            </select>
        </div>

        <!-- Date Inputs (for Top Customers) -->
        <div id="dateInputs" class="col-md-6">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="report-label" for="fromDate">From Date</label>
                    <input type="date" id="fromDate" name="fromDate" class="form-control" value="2024-01-01" />
                </div>
                <div class="col-md-6">
                    <label class="report-label" for="toDate">To Date</label>
                    <input type="date" id="toDate" name="toDate" class="form-control" value="2024-12-31" />
                </div>
            </div>
        </div>

        <!-- Year Input (for Monthly Sales Summary) -->
        <div id="yearInput" class="col-md-6 hidden">
            <label class="report-label" for="year">Year</label>
            <input type="number" id="year" name="year" class="form-control" value="2024" min="2000" />
        </div>

        <div class="col-md-3">
            <label class="report-label" for="customerLimit">Limit</label>
            <input type="number" id="customerLimit" name="customerLimit" class="form-control" value="10" min="1" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button id="generateReportBtn" type="button" class="btn btn-purple w-100">
                <i class="bi bi-bar-chart-fill"></i> Generate Report
            </button>
        </div>
    </div>

    <!-- KPI Cards Row -->
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="kpi-card">
                <h5>Total Sales</h5>
                <h2 id="totalSalesKPI">LKR 0.00</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card">
                <h5>Total Orders</h5>
                <h2 id="totalOrdersKPI">0</h2>
            </div>
        </div>
        <div class="col-md-4">
            <div class="kpi-card">
                <h5>Avg. Order Value</h5>
                <h2 id="avgOrderValueKPI">LKR 0.00</h2>
            </div>
        </div>
    </div>

    <!-- Live text filter -->
    <input
        type="text"
        id="liveFilterInput"
        placeholder="Live Filter: Search in reports..."
        title="Type to filter the reports table"
    />

    <!-- Export Buttons -->
    <div class="export-btns text-end mb-3">
        <button id="exportCsvBtn" type="button" class="btn btn-outline-info">
            <i class="bi bi-file-earmark-spreadsheet-fill"></i> Export CSV
        </button>
        <button type="button" class="btn btn-outline-success">
            <i class="bi bi-file-earmark-excel-fill"></i> Export Excel
        </button>
        <button type="button" class="btn btn-outline-danger">
            <i class="bi bi-file-pdf-fill"></i> Export PDF
        </button>
    </div>
    
    <!-- Loading spinner -->
    <div id="loadingSpinner" class="text-center spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span class="ms-2">Generating your report...</span>
    </div>

    <!-- Charts Row -->
    <div id="chartsRow" class="row g-4">
        <!-- Chart Container will be dynamically added/removed -->
    </div>

    <!-- Reports Table -->
    <div class="table-responsive">
        <table id="reportsTable" class="table table-hover align-middle">
            <thead>
                <tr>
                    <!-- Dynamic headers will be inserted here -->
                </tr>
            </thead>
            <tbody>
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // Initializing Chart.js instances as global variables
    let currentCharts = {}; // Stores all chart instances
    
    // NOTE: The original code attempted to fetch data from a 'localhost' URL.
    // This is not possible in this hosted environment due to security restrictions.
    // To make the dashboard functional, the fetch function has been replaced
    // with a mock implementation that returns hardcoded JSON data after a delay.
    // For a production app, you would replace this with a call to your live server.

    // Helper function to show/hide input fields based on selected report type
    function updateInputFields() {
        const reportType = document.getElementById('reportType').value;
        const dateInputs = document.getElementById('dateInputs');
        const yearInput = document.getElementById('yearInput');
        const customerLimitInput = document.getElementById('customerLimit');

        if (reportType === 'topcustomers') {
            dateInputs.classList.remove('hidden');
            yearInput.classList.add('hidden');
            customerLimitInput.disabled = false;
        } else if (reportType === 'monthly-sales-summary') {
            dateInputs.classList.add('hidden');
            yearInput.classList.remove('hidden');
            customerLimitInput.disabled = true; // Not needed for this report
        }
    }
    
    // Asynchronously fetches report data from a mock data source.
    async function fetchReportData(reportType, params) {
        // Simulate a network delay
        await new Promise(resolve => setTimeout(resolve, 1000)); 

        const mockData = {
            'topcustomers': [
                { rank: 1, firstName: 'Nimal', lastName: 'Perera', email: 'nimal.p@email.com', totalOrders: 15, totalSpent: 15450.75, loyaltyPoints: 300, topCategory: 'Science Books' },
                { rank: 2, firstName: 'Kamala', lastName: 'Silva', email: 'kamala.s@email.com', totalOrders: 12, totalSpent: 12100.20, loyaltyPoints: 250, topCategory: 'History' },
                { rank: 3, firstName: 'Sunil', lastName: 'Bandara', email: 'sunil.b@email.com', totalOrders: 10, totalSpent: 10890.00, loyaltyPoints: 220, topCategory: 'Math' },
                { rank: 4, firstName: 'Aisha', lastName: 'Khan', email: 'aisha.k@email.com', totalOrders: 8, totalSpent: 9550.50, loyaltyPoints: 180, topCategory: 'Science Books' },
                { rank: 5, firstName: 'Priya', lastName: 'Fernando', email: 'priya.f@email.com', totalOrders: 7, totalSpent: 7800.00, loyaltyPoints: 150, topCategory: 'Fiction' },
                { rank: 6, firstName: 'Tharindu', lastName: 'Jayawardena', email: 'tharindu.j@email.com', totalOrders: 6, totalSpent: 6200.00, loyaltyPoints: 120, topCategory: 'History' },
                { rank: 7, firstName: 'Lakshmi', lastName: 'De Silva', email: 'lakshmi.d@email.com', totalOrders: 5, totalSpent: 5900.00, loyaltyPoints: 100, topCategory: 'Science Books' },
                { rank: 8, firstName: 'Chamara', lastName: 'Gamage', email: 'chamara.g@email.com', totalOrders: 4, totalSpent: 4500.00, loyaltyPoints: 90, topCategory: 'Math' },
                { rank: 9, firstName: 'Saman', lastName: 'Sirisena', email: 'saman.s@email.com', totalOrders: 4, totalSpent: 3800.00, loyaltyPoints: 80, topCategory: 'Fiction' },
                { rank: 10, firstName: 'Anusha', lastName: 'Perera', email: 'anusha.p@email.com', totalOrders: 3, totalSpent: 3100.00, loyaltyPoints: 60, topCategory: 'History' }
            ],
            'monthly-sales-summary': [
                { month: 'January', totalSales: 120000, numberOfTransactions: 150 },
                { month: 'February', totalSales: 145000, numberOfTransactions: 180 },
                { month: 'March', totalSales: 130000, numberOfTransactions: 165 },
                { month: 'April', totalSales: 160000, numberOfTransactions: 200 },
                { month: 'May', totalSales: 185000, numberOfTransactions: 215 },
                { month: 'June', totalSales: 170000, numberOfTransactions: 195 },
                { month: 'July', totalSales: 200000, numberOfTransactions: 230 },
                { month: 'August', totalSales: 190000, numberOfTransactions: 210 },
                { month: 'September', totalSales: 210000, numberOfTransactions: 240 },
                { month: 'October', totalSales: 225000, numberOfTransactions: 255 },
                { month: 'November', totalSales: 240000, numberOfTransactions: 270 },
                { month: 'December', totalSales: 260000, numberOfTransactions: 300 }
            ]
        };

        const data = mockData[reportType] || [];
        // Apply limit if specified
        if (params.limit) {
            return data.slice(0, params.limit);
        }
        return data;
    }

    // Function to populate the reports table with data
    function populateReportsTable(reportType, data) {
        const tableHeader = document.getElementById('reportsTable').getElementsByTagName('thead')[0];
        const tableBody = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
        tableHeader.innerHTML = ''; // Clear existing headers
        tableBody.innerHTML = ''; // Clear existing data

        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data found for the selected period.</td></tr>';
            return;
        }

        // Set dynamic headers and content based on report type
        if (reportType === 'topcustomers') {
            const headers = ['Rank', 'Customer Name', 'Email', 'Total Orders', 'Total Spent (LKR)', 'Loyalty Points', 'Top Category'];
            tableHeader.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            data.forEach(customer => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${customer.rank}</td>
                    <td>${customer.firstName} ${customer.lastName}</td>
                    <td>${customer.email}</td>
                    <td>${customer.totalOrders}</td>
                    <td>LKR ${customer.totalSpent.toFixed(2)}</td>
                    <td>${customer.loyaltyPoints}</td>
                    <td>${customer.topCategory}</td>
                `;
            });
        } else if (reportType === 'monthly-sales-summary') {
            const headers = ['Month', 'Total Sales (LKR)', 'Number of Transactions'];
            tableHeader.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            data.forEach(summary => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${summary.month}</td>
                    <td>LKR ${summary.totalSales.toFixed(2)}</td>
                    <td>${summary.numberOfTransactions}</td>
                `;
            });
        }
    }

    // Function to update the charts with new data
    function updateCharts(reportType, data) {
        // Destroy existing charts
        for (const key in currentCharts) {
            currentCharts[key].destroy();
        }
        currentCharts = {};
        document.getElementById('chartsRow').innerHTML = ''; // Clear old chart containers

        if (data.length === 0) {
            return;
        }

        if (reportType === 'topcustomers') {
            const customerNames = data.map(c => `${c.firstName} ${c.lastName}`);
            const totalSpent = data.map(c => c.totalSpent);
            const loyaltyPoints = data.map(c => c.loyaltyPoints);
            const categoryCounts = data.reduce((acc, customer) => {
                acc[customer.topCategory] = (acc[customer.topCategory] || 0) + 1;
                return acc;
            }, {});
            const categoryLabels = Object.keys(categoryCounts);
            const categoryData = Object.values(categoryCounts);
            const categoryColors = ['#6a1b9a', '#ab47bc', '#ce93d8', '#e1bee7', '#9c27b0', '#ba68c8'];
            
            // Re-create chart containers
            document.getElementById('chartsRow').innerHTML = `
                <div class="col-md-4 chart-container">
                    <div class="chart-title">Top Customers by Total Spending</div>
                    <canvas id="totalSpentChart"></canvas>
                </div>
                <div class="col-md-4 chart-container">
                    <div class="chart-title">Distribution of Top Categories</div>
                    <canvas id="topCategoriesChart"></canvas>
                </div>
                <div class="col-md-4 chart-container">
                    <div class="chart-title">Top Customers by Loyalty Points</div>
                    <canvas id="loyaltyPointsChart"></canvas>
                </div>
            `;
            
            // Bar Chart for Total Spending
            const totalSpentCtx = document.getElementById('totalSpentChart').getContext('2d');
            currentCharts.totalSpent = new Chart(totalSpentCtx, {
                type: 'bar',
                data: {
                    labels: customerNames,
                    datasets: [{
                        label: 'Total Spent (LKR)',
                        data: totalSpent,
                        backgroundColor: '#6a1b9a',
                        borderRadius: 5,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: val => `LKR ${val}` }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Pie Chart for Top Categories
            const topCategoriesCtx = document.getElementById('topCategoriesChart').getContext('2d');
            currentCharts.topCategories = new Chart(topCategoriesCtx, {
                type: 'pie',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: categoryColors.slice(0, categoryLabels.length),
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Bar Chart for Loyalty Points
            const loyaltyPointsCtx = document.getElementById('loyaltyPointsChart').getContext('2d');
            currentCharts.loyaltyPoints = new Chart(loyaltyPointsCtx, {
                type: 'bar',
                data: {
                    labels: customerNames,
                    datasets: [{
                        label: 'Loyalty Points',
                        data: loyaltyPoints,
                        backgroundColor: '#ab47bc',
                        borderRadius: 5,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

        } else if (reportType === 'monthly-sales-summary') {
            const months = data.map(s => s.month);
            const totalSales = data.map(s => s.totalSales);
            const numberOfTransactions = data.map(s => s.numberOfTransactions);
            
            document.getElementById('chartsRow').innerHTML = `
                <div class="col-md-6 chart-container">
                    <div class="chart-title">Total Sales per Month</div>
                    <canvas id="monthlySalesChart"></canvas>
                </div>
                <div class="col-md-6 chart-container">
                    <div class="chart-title">Number of Transactions per Month</div>
                    <canvas id="monthlyTransactionsChart"></canvas>
                </div>
            `;

            // Bar Chart for Monthly Sales
            const monthlySalesCtx = document.getElementById('monthlySalesChart').getContext('2d');
            currentCharts.monthlySales = new Chart(monthlySalesCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Total Sales (LKR)',
                        data: totalSales,
                        backgroundColor: '#6a1b9a',
                        borderRadius: 5,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: val => `LKR ${val}` }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Line Chart for Monthly Transactions
            const monthlyTransactionsCtx = document.getElementById('monthlyTransactionsChart').getContext('2d');
            currentCharts.monthlyTransactions = new Chart(monthlyTransactionsCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Number of Transactions',
                        data: numberOfTransactions,
                        backgroundColor: 'rgba(171, 71, 188, 0.5)',
                        borderColor: '#ab47bc',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }
    }

    // Function to update the KPI cards
    function updateKPIs(reportType, data) {
        if (reportType === 'topcustomers') {
            const totalSales = data.reduce((sum, customer) => sum + customer.totalSpent, 0);
            const totalOrders = data.reduce((sum, customer) => sum + customer.totalOrders, 0);
            const avgOrderValue = totalSales / (totalOrders > 0 ? totalOrders : 1);
            document.getElementById('totalSalesKPI').innerText = `LKR ${totalSales.toFixed(2)}`;
            document.getElementById('totalOrdersKPI').innerText = totalOrders.toString();
            document.getElementById('avgOrderValueKPI').innerText = `LKR ${avgOrderValue.toFixed(2)}`;
        } else if (reportType === 'monthly-sales-summary') {
            const totalSales = data.reduce((sum, summary) => sum + summary.totalSales, 0);
            const totalOrders = data.reduce((sum, summary) => sum + summary.numberOfTransactions, 0);
            const avgSalesPerMonth = totalSales / (data.length > 0 ? data.length : 1);
            document.getElementById('totalSalesKPI').innerText = `LKR ${totalSales.toFixed(2)}`;
            document.getElementById('totalOrdersKPI').innerText = totalOrders.toString();
            document.getElementById('avgOrderValueKPI').innerText = `LKR ${avgSalesPerMonth.toFixed(2)} (Per Month)`;
        }
    }


    /**
     * Converts the current table data to a CSV and triggers a download.
     */
    function exportTableToCSV() {
        // Get the reports table
        const table = document.getElementById('reportsTable');
        if (!table) return;

        // Get the header cells
        const headers = Array.from(table.querySelectorAll('thead th')).map(header => {
            let text = header.innerText.trim();
            // Clean up the header text for the CSV
            text = text.replace('(LKR)', '').replace('Rank', '').trim();
            return text;
        }).filter(Boolean); // Remove empty strings

        // Get all visible rows from the tbody
        const rows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');

        // Check if there are rows to export
        if (rows.length === 0) {
            console.warn('No data to export.');
            return;
        }

        // Map the rows to a CSV format
        const csvContent = [
            headers.join(','), // CSV header line
            ...rows.map(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                return cells.map(cell => {
                    // Extract text, clean up the 'LKR ' prefix, and handle commas
                    let text = cell.innerText.replace(/LKR /g, '').trim();
                    if (text.includes(',')) {
                        text = `"${text}"`; // Quote the text if it contains a comma
                    }
                    return text;
                }).join(',');
            })
        ].join('\n');

        // Create a Blob from the CSV string
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        // Create a temporary link element to trigger the download
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', 'PahanaEdu_Report.csv');
        link.style.display = 'none'; // Hide the link
        document.body.appendChild(link);

        // Simulate a click to download the file
        link.click();

        // Clean up by removing the link and revoking the object URL
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // Function to handle the generation of the report
    async function generateReport() {
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'flex';
        // Clear previous error messages
        document.getElementById('reportsTable').getElementsByTagName('tbody')[0].innerHTML = '';

        const reportType = document.getElementById('reportType').value;
        const params = {};
        
        // Collect parameters based on report type
        if (reportType === 'topcustomers') {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            const customerLimit = parseInt(document.getElementById('customerLimit').value, 10);
            
            if (!fromDate || !toDate || isNaN(customerLimit) || customerLimit < 1) {
                displayErrorMessage('Please enter valid dates and a number for the limit.');
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }
            params.startDate = fromDate;
            params.endDate = toDate;
            params.limit = customerLimit;
        } else if (reportType === 'monthly-sales-summary') {
            const year = document.getElementById('year').value;
            
            if (!year || isNaN(year)) {
                displayErrorMessage('Please enter a valid year.');
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }
            params.year = year;
        }
        
        try {
            const reportData = await fetchReportData(reportType, params);
            populateReportsTable(reportType, reportData);
            updateKPIs(reportType, reportData);
            updateCharts(reportType, reportData);
        } catch (error) {
            console.error('Failed to generate report:', error);
            let errorMessage = `An error occurred while generating the report. Error: ${error.message}`;
            displayErrorMessage(errorMessage);
        } finally {
            // Hide loading spinner
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    }
    
    function displayErrorMessage(message) {
        const tableBody = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">${message}</td></tr>`;
    }

    // Live Filter Functionality (remains the same)
    const liveFilterInput = document.getElementById('liveFilterInput');
    liveFilterInput.addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        const reportsTable = document.getElementById('reportsTable').getElementsByTagName('tbody')[0];
        const rows = reportsTable.getElementsByTagName('tr');

        Array.from(rows).forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(filter) ? '' : 'none';
        });
    });

    // Attach event listeners
    document.getElementById('generateReportBtn').addEventListener('click', generateReport);
    document.getElementById('exportCsvBtn').addEventListener('click', exportTableToCSV);
    document.getElementById('reportType').addEventListener('change', updateInputFields);

    // Initial report generation on page load
    window.onload = function() {
        updateInputFields(); // Set initial state of inputs
        generateReport();
    };

</script>

</body>
</html>
