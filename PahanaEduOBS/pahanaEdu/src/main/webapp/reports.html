<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Dashboard - PahanaEdu</title>
    <!-- Bootstrap CSS for the provided navigation bar styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons for the icons in the navigation bar -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Tailwind CSS CDN for the rest of the dashboard styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Chart.js Data Labels plugin to show values on charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom Tailwind configuration to match the provided color scheme */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pahana-dark-purple': '#6a1b9a',
                        'pahana-medium-purple': '#ab47bc',
                        'pahana-light-purple': '#ce93d8',
                        'pahana-very-light-purple': '#e1bee7',
                        'pahana-card-text': '#4a148c',
                    },
                    backgroundImage: {
                        'header-gradient': 'linear-gradient(to right, #6a1b9a, #ab47bc)',
                        'card-gradient': 'linear-gradient(to right, #ce93d8, #e1bee7)',
                    }
                }
            }
        }
    </style>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #e1bee7; /* Using a solid color that matches the provided light purple */
        }
        /* Class for the gradient text effect on the title */
        .text-header-gradient {
            background-image: linear-gradient(to right, #ce93d8, #4a148c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback for browsers that don't support text-fill-color */
        }
    </style>
</head>
<body class="text-gray-900 min-h-screen">
    
    <!-- Navigation Bar (Provided by the user) -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(to right, #6a1b9a, #8e24aa); padding: 10px 30px;">
        <div class="container-fluid">
            <a class="navbar-brand me-3" href="#" onclick="history.back()">
                <i class="bi bi-arrow-left-circle-fill"></i>
            </a>
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="bi bi-house-door-fill"></i> PahanaEdu
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-between" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="dashboard.html">
                            <i class="bi bi-house-fill"></i> Home
                        </a>
                    </li>
                </ul>

                <div class="d-flex">
                    <a href="logout.html" class="btn btn-light text-dark fw-semibold rounded-pill">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container for Dashboard -->
    <div class="max-w-7xl mx-auto bg-white/95 rounded-3xl shadow-2xl p-6 md:p-10 my-8 transition-all duration-300">

        <!-- Header -->
        <header class="bg-header-gradient text-center py-6 px-4 rounded-2xl shadow-lg mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold flex items-center justify-center space-x-3 text-header-gradient">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 md:h-10 md:w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span>Reports Dashboard</span>
            </h1>
        </header>

        <!-- Report Filter Section -->
        <section class="bg-gray-200 p-6 rounded-2xl shadow-inner mb-8">
            <h2 class="text-2xl font-semibold text-pahana-dark-purple mb-4">Report Filters</h2>
            <form id="reportForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <!-- Date Filter Inputs -->
                <div class="col-span-1">
                    <label for="fromDate" class="block text-sm font-medium text-gray-600">From Date</label>
                    <input type="date" id="fromDate" name="fromDate" required class="mt-1 block w-full rounded-md border-gray-400 bg-white text-gray-900 shadow-sm focus:border-pahana-dark-purple focus:ring-pahana-dark-purple sm:text-sm p-2">
                </div>
                <div class="col-span-1">
                    <label for="toDate" class="block text-sm font-medium text-gray-600">To Date</label>
                    <input type="date" id="toDate" name="toDate" required class="mt-1 block w-full rounded-md border-gray-400 bg-white text-gray-900 shadow-sm focus:border-pahana-dark-purple focus:ring-pahana-dark-purple sm:text-sm p-2">
                </div>
                <div class="col-span-1">
                    <label for="limit" class="block text-sm font-medium text-gray-600">Customer Limit</label>
                    <input type="number" id="limit" name="limit" value="10" min="1" class="mt-1 block w-full rounded-md border-gray-400 bg-white text-gray-900 shadow-sm focus:border-pahana-dark-purple focus:ring-pahana-dark-purple sm:text-sm p-2">
                </div>
            </form>
            <!-- Download Buttons -->
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-4">
                <button id="downloadPdfBtn" class="w-full md:w-1/2 inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200">
                    Download as PDF
                </button>
                <button id="downloadExcelBtn" class="w-full md:w-1/2 inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                    Download as Excel
                </button>
            </div>
        </section>
        
        <!-- Loading and Error State -->
        <div id="loading" class="text-center text-lg text-pahana-dark-purple font-semibold hidden">
            <div class="animate-spin inline-block h-8 w-8 border-4 border-pahana-dark-purple border-t-transparent rounded-full mr-2"></div>
            <span>Loading report data...</span>
        </div>
        <div id="error-message" class="bg-red-200 border-l-4 border-red-500 text-red-700 p-4 rounded-md hidden" role="alert">
            <p class="font-bold">Error!</p>
            <p id="error-text"></p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- Summary Cards Section -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Total Sales Card -->
                <div class="bg-card-gradient text-pahana-card-text rounded-2xl p-6 shadow-xl text-center">
                    <h3 class="text-xl font-medium opacity-80 mb-2">Total Sales (LKR)</h3>
                    <p id="totalSales" class="text-4xl font-bold">LKR 0.00</p>
                </div>
                <!-- Total Orders Card -->
                <div class="bg-card-gradient text-pahana-card-text rounded-2xl p-6 shadow-xl text-center">
                    <h3 class="text-xl font-medium opacity-80 mb-2">Total Orders</h3>
                    <p id="totalOrders" class="text-4xl font-bold">0</p>
                </div>
                <!-- Average Order Value Card -->
                <div class="bg-card-gradient text-pahana-card-text rounded-2xl p-6 shadow-xl text-center">
                    <h3 class="text-xl font-medium opacity-80 mb-2">Avg. Order Value (LKR)</h3>
                    <p id="avgOrderValue" class="text-4xl font-bold">LKR 0.00</p>
                </div>
            </section>
        
            <!-- Charts Section -->
            <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Top Customers by Total Spending Chart -->
                <div class="bg-gray-200 p-6 rounded-2xl shadow-lg flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-pahana-dark-purple mb-4">Top Customers by Total Spending</h3>
                    <div class="w-full h-80">
                        <canvas id="totalSpendingChart"></canvas>
                    </div>
                </div>
                <!-- Distribution of Top Categories Chart -->
                <div class="bg-gray-200 p-6 rounded-2xl shadow-lg flex flex-col items-center">
                    <h3 class="text-xl font-semibold text-pahana-dark-purple mb-4">Distribution of Top Categories</h3>
                    <div class="w-full h-80">
                        <canvas id="topCategoriesChart"></canvas>
                    </div>
                </div>
                <!-- Top Customers by Loyalty Points Chart -->
                <div class="bg-gray-200 p-6 rounded-2xl shadow-lg flex flex-col items-center col-span-full md:col-span-1">
                    <h3 class="text-xl font-semibold text-pahana-dark-purple mb-4">Top Customers by Loyalty Points</h3>
                    <div class="w-full h-80">
                        <canvas id="loyaltyPointsChart"></canvas>
                    </div>
                </div>
                <!-- Monthly Sales Trend Chart -->
                <div class="bg-gray-200 p-6 rounded-2xl shadow-lg flex flex-col items-center col-span-full md:col-span-1">
                    <h3 class="text-xl font-semibold text-pahana-dark-purple mb-4">Monthly Sales Trend</h3>
                    <div class="w-full h-80">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </section>
        
            <!-- Top Customers Table Section -->
            <section class="bg-gray-200 p-6 rounded-2xl shadow-lg overflow-x-auto">
                <h3 class="text-xl font-semibold text-pahana-dark-purple mb-4">Top Customers Details</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-300">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tl-xl">Rank</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Customer Name</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Total Orders</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Total Spent (LKR)</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Loyalty Points</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tr-xl">Top Category</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody" class="bg-white divide-y divide-gray-300 text-gray-800">
                            <!-- Table rows will be inserted here dynamically -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Bootstrap JS for navbar functionality (toggler) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Register the datalabels plugin globally. This is required for Chart.js.
        Chart.register(ChartDataLabels);

        // Define API endpoints
        const API_BASE_URL = "http://localhost:8080/OBS_PahanaEdu_BE/api/reports";
        const TOTAL_SALES_ENDPOINT = `${API_BASE_URL}/top-customers`;
        const MONTHLY_SALES_ENDPOINT = `${API_BASE_URL}/monthly-sales-summary`;

        // Get DOM elements for manipulation
        const fromDateInput = document.getElementById('fromDate');
        const toDateInput = document.getElementById('toDate');
        const limitInput = document.getElementById('limit');
        const loadingSpinner = document.getElementById('loading');
        const errorMessageDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const dashboardContent = document.getElementById('dashboardContent');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');

        // Chart instances
        let totalSpendingChart, topCategoriesChart, loyaltyPointsChart, monthlySalesChart;

        /**
         * Hides the dashboard content and displays a loading message.
         */
        function showLoading() {
            dashboardContent.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
        }

        /**
         * Hides the loading message and displays an error message.
         * @param {string} message The error message to display.
         */
        function showError(message) {
            loadingSpinner.classList.add('hidden');
            dashboardContent.classList.add('hidden');
            errorMessageDiv.classList.remove('hidden');
            errorText.textContent = message;
        }

        /**
         * Hides the loading and error messages and displays the dashboard content.
         */
        function showContent() {
            loadingSpinner.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
        }

        /**
         * Fetches all report data from the API endpoints.
         * @returns {Promise<Object>} A promise that resolves to an object containing all report data.
         */
        async function fetchAllReportData() {
            const fromDate = fromDateInput.value;
            const toDate = toDateInput.value;
            const limit = limitInput.value;

            if (!fromDate || !toDate || !limit) {
                showError("Please fill in all required fields to see the report.");
                return;
            }

            showLoading();

            try {
                // Fetch top customers report
                const topCustomersUrl = new URL(TOTAL_SALES_ENDPOINT);
                topCustomersUrl.searchParams.append('fromDate', fromDate);
                topCustomersUrl.searchParams.append('toDate', toDate);
                topCustomersUrl.searchParams.append('limit', limit);
                const topCustomersRes = await fetch(topCustomersUrl);
                const topCustomersData = await topCustomersRes.json();
                if (!topCustomersRes.ok) throw new Error(topCustomersData.message || 'Failed to fetch top customers data.');

                // Fetch monthly sales summary
                const monthlySalesUrl = new URL(MONTHLY_SALES_ENDPOINT);
                monthlySalesUrl.searchParams.append('year', new Date(fromDate).getFullYear());
                const monthlySalesRes = await fetch(monthlySalesUrl);
                const monthlySalesData = await monthlySalesRes.json();
                if (!monthlySalesRes.ok) throw new Error(monthlySalesData.message || 'Failed to fetch monthly sales data.');

                showContent();
                return { topCustomersData, monthlySalesData };

            } catch (error) {
                console.error('API fetch error:', error);
                showError(`Error fetching data: ${error.message}`);
                return null;
            }
        }

        /**
         * Updates the summary cards with calculated data.
         * @param {Array<Object>} customers The top customers data array.
         */
        function updateSummaryCards(customers) {
            let totalSales = 0;
            let totalOrders = 0;

            customers.forEach(cust => {
                totalSales += cust.totalSpent;
                totalOrders += cust.totalOrders;
            });

            const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

            document.getElementById('totalSales').textContent = `LKR ${totalSales.toFixed(2)}`;
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('avgOrderValue').textContent = `LKR ${avgOrderValue.toFixed(2)}`;
        }

        /**
         * Renders the charts using the fetched data.
         * @param {Array<Object>} customers The top customers data array.
         * @param {Array<Object>} monthlySales The monthly sales summary data array.
         */
        function renderCharts(customers, monthlySales) {
            // Destroy existing chart instances to prevent duplicates
            if (totalSpendingChart) totalSpendingChart.destroy();
            if (topCategoriesChart) topCategoriesChart.destroy();
            if (loyaltyPointsChart) loyaltyPointsChart.destroy();
            if (monthlySalesChart) monthlySalesChart.destroy();

            const customerNames = customers.map(c => `${c.firstName} ${c.lastName || ''}`);
            const totalSpent = customers.map(c => c.totalSpent);
            const loyaltyPoints = customers.map(c => c.loyaltyPoints);

            // Chart 1: Top Customers by Total Spending
            const totalSpendingCtx = document.getElementById('totalSpendingChart').getContext('2d');
            totalSpendingChart = new Chart(totalSpendingCtx, {
                type: 'bar',
                data: {
                    labels: customerNames,
                    datasets: [{
                        label: 'Total Spent (LKR)',
                        data: totalSpent,
                        backgroundColor: '#6a1b9a', // A bright purple
                        borderColor: '#ab47bc',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: '#4a148c' }
                        },
                        x: { 
                            display: false,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: '#4a148c' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Top Customers by Total Spending', color: '#4a148c' },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#4a148c',
                            formatter: (value) => `LKR ${value.toFixed(2)}`
                        }
                    }
                }
            });

            // Process data for Chart 2: Top Categories
            const categoryMap = customers.reduce((acc, curr) => {
                const category = curr.topCategory || 'Other';
                acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {});
            const categoryLabels = Object.keys(categoryMap);
            const categoryData = Object.values(categoryMap);

            const topCategoriesCtx = document.getElementById('topCategoriesChart').getContext('2d');
            topCategoriesChart = new Chart(topCategoriesCtx, {
                type: 'pie',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Top Categories',
                        data: categoryData,
                        backgroundColor: [
                            '#6a1b9a', '#ab47bc', '#ce93d8', '#e1bee7', '#4a148c'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: { color: '#4a148c' }
                        },
                        title: { display: true, text: 'Distribution of Top Categories', color: '#4a148c' },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((sum, v) => sum + v, 0);
                                const percentage = (value / total * 100).toFixed(1) + '%';
                                return percentage;
                            }
                        }
                    }
                }
            });

            // Chart 3: Top Customers by Loyalty Points
            const loyaltyPointsCtx = document.getElementById('loyaltyPointsChart').getContext('2d');
            loyaltyPointsChart = new Chart(loyaltyPointsCtx, {
                type: 'bar',
                data: {
                    labels: customerNames,
                    datasets: [{
                        label: 'Loyalty Points',
                        data: loyaltyPoints,
                        backgroundColor: '#ab47bc',
                        borderColor: '#ce93d8',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: '#4a148c' }
                        },
                        x: { 
                            display: false,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: '#4a148c' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Top Customers by Loyalty Points', color: '#4a148c' },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#4a148c',
                            formatter: (value) => value
                        }
                    }
                }
            });

            // Process data for Chart 4: Monthly Sales Trend
            const monthlyLabels = monthlySales.map(item => item.month);
            const monthlyData = monthlySales.map(item => item.totalSales);

            const monthlySalesCtx = document.getElementById('monthlySalesChart').getContext('2d');
            monthlySalesChart = new Chart(monthlySalesCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Total Sales (LKR)',
                        data: monthlyData,
                        fill: false,
                        borderColor: '#6a1b9a',
                        tension: 0.1,
                        pointBackgroundColor: '#ab47bc',
                        pointBorderColor: '#fff',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: '#4a148c' }
                        },
                        x: { 
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { color: '#4a148c' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Monthly Sales Trend', color: '#4a148c' },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#4a148c',
                            formatter: (value) => `LKR ${value.toFixed(0)}`
                        }
                    }
                }
            });
        }

        /**
         * Populates the customer table with data.
         * @param {Array<Object>} customers The top customers data array.
         */
        function populateCustomerTable(customers) {
            const tbody = document.getElementById('customerTableBody');
            tbody.innerHTML = '';
            if (customers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No customers found for the selected criteria.</td></tr>';
                return;
            }

            customers.forEach((cust, index) => {
                const row = `
                    <tr class="hover:bg-gray-200 transition-colors duration-100">
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${cust.firstName} ${cust.lastName || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${cust.email || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${cust.totalOrders}</td>
                        <td class="px-6 py-4 whitespace-nowrap">LKR ${cust.totalSpent.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${cust.loyaltyPoints}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${cust.topCategory || '-'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        /**
         * The main function to run the report generation logic.
         */
        async function runReport() {
            const data = await fetchAllReportData();
            if (data) {
                updateSummaryCards(data.topCustomersData);
                renderCharts(data.topCustomersData, data.monthlySalesData);
                populateCustomerTable(data.topCustomersData);
            }
        }

        /**
         * Generates a PDF of the entire dashboard content.
         */
        function generateReportPdf() {
            const element = document.getElementById('dashboardContent');
            if (!element || element.classList.contains('hidden')) {
                 showError('Please select dates to generate a report first before attempting to download.');
                 return;
            }

            const loader = document.createElement('div');
            loader.innerHTML = '<div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"><div class="animate-spin inline-block h-12 w-12 border-4 border-pahana-dark-purple border-t-transparent rounded-full mr-2"></div><span class="text-white text-lg font-semibold">Generating PDF...</span></div>';
            document.body.appendChild(loader);

            html2canvas(element, {
                scale: 2, // Improves quality of the generated image
                useCORS: true, // This is important if you have images from other domains
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save('PahanaEdu_Report.pdf');
                document.body.removeChild(loader);
            }).catch(error => {
                document.body.removeChild(loader);
                showError('Failed to generate PDF. Please try again.');
                console.error('PDF generation error:', error);
            });
        }
        
        /**
         * Generates a CSV file from the customer table and downloads it.
         */
        function generateReportExcel() {
             const table = document.getElementById('customerTableBody');
             if (!table || table.children.length === 0 || (table.children.length === 1 && table.children[0].textContent.includes("No customers found"))) {
                 showError('Please generate a report with data first before attempting to download as Excel.');
                 return;
             }
            
            const tableRows = table.querySelectorAll('tr');
            let csv = 'Rank,Customer Name,Email,Total Orders,Total Spent (LKR),Loyalty Points,Top Category\n';
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`).join(',');
                csv += rowData + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'PahanaEdu_Customers.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Set default dates and add event listeners
        window.onload = () => {
            const today = new Date();
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1).toISOString().slice(0, 10);
            const todayISO = today.toISOString().slice(0, 10);
            fromDateInput.value = firstDayOfYear;
            toDateInput.value = todayISO;
            // Run the report immediately on load with default dates
            runReport();
        };

        // Event listeners to trigger report generation on input change
        fromDateInput.addEventListener('change', runReport);
        toDateInput.addEventListener('change', runReport);
        limitInput.addEventListener('change', runReport);
        
        // Event listeners for download buttons
        downloadPdfBtn.addEventListener('click', generateReportPdf);
        downloadExcelBtn.addEventListener('click', generateReportExcel);
    </script>
</body>
</html>
